# GitHub Actions Workflow for Austin Meeting Monitor
# Runs twice daily at 8 AM and 6 PM Central Time to check for new meetings

name: Monitor Austin City Council Meetings

on:
  schedule:
    # Run at 8 AM Central (2 PM UTC)
    - cron: '0 14 * * *'
    # Run at 6 PM Central (12 AM UTC next day)
    - cron: '0 0 * * *'
  
  # Allow manual triggering from GitHub Actions tab
  workflow_dispatch:

jobs:
  check-meetings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-generativeai PyMuPDF beautifulsoup4 requests
    
    - name: Download existing database (if exists)
      continue-on-error: true
      run: |
        # Try to download the database from the previous run
        # This preserves meeting history across runs
        if [ -f austin_meetings.db ]; then
          echo "Database already exists locally"
        else
          echo "No existing database found, will create new one"
        fi
    
    - name: Run meeting monitor
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        python austin_meeting_monitor_gemini.py
    
    - name: Commit and push database updates
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add austin_meetings.db
        git diff --quiet && git diff --staged --quiet || git commit -m "Update meeting database - $(date +'%Y-%m-%d %H:%M')"
        git push
      continue-on-error: true
    
    - name: Upload database as artifact
      uses: actions/upload-artifact@v3
      with:
        name: austin-meetings-database
        path: austin_meetings.db
        retention-days: 90
